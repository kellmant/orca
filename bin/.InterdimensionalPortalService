#/!/bin/bash
#set -eo pipefail
#IFS=$'\n'
#shopt -s nullglob 
shopt -s checkwinsize
#need this to get the basic variables

PROTO="http"
KEYHOST="${PROTO}://keystore:2379"
ETCDCTL_ENDPOINTS=${KEYHOST}
KEYSTORE="${KEYHOST}/v2/keys"
ipscmd="$(basename $0)"
keycmd=$(echo "$ipscmd" | cut -d '-' -f 2-)
ipsenv="env/$keycmd"
trustedca="/path/to/ca-chain.crt"
clientcrt="/path/to/client.pem"
clientkey="/path/to/client.key"
msgttl=86400
cmdhost=$(hostname)

# we can use keystore or local var to manage the rest.
# your call.
#
KEYCURL="curl -s"

if [ "$PROTO" != "https" ] ; then
	restget="$KEYCURL -L"
	restput="$KEYCURL -X PUT"
	else
	restget="$KEYCURL --cacert ${trustedca} --cert ${clientcrt} --key ${clientkey} -L"
	restput="$KEYCURL --cacert ${trustedca} --cert ${clientcrt} --key ${clientkey} -X PUT"
fi
readrest="jq -r '.node.value'" 
	# watch a key keys/foo?wait=true
restwatch="wait=true"
	#detailed and recursive listing ?recursive=true&sorted=true'
restsort="sorted=true"
restrecurse="recursive=true&sorted=true"
ALLKEYS="$KEYCURL $KEYSTORE/$SESSIONKEY/${restrecurse}"
	# store small files keys/afile -XPUT --data-urlencode value@afile.txt
reststore="--data-urlencode"
	#set ttl keys/foo?ttl=20 -d value=bar
	#set ttl on dir keys/dir -XPUT -d ttl=30 -d dir=true
	# directory with value
	# delete key curl -L -X DELETE http://127.0.0.1:2379/v2/keys/message
	# recursive del curl http://127.0.0.1:2379/v2/keys/dir?recursive=true -XDELETE
# add some general variables for our scripts
JKEY=$($restget $KEYSTORE/usr/${BUD}/session)
SKEY=$(echo "$JKEY" | jq -r '.node.value')

JSKEY () {
    showret=$(echo "$@" | jq -r '.node.value')
    echo "${showret}"
}

# overide in the keystore, do not edit this file!
PULLKEY="$restget $KEYSTORE/$SESSIONKEY"
PULLENV="$PULLKEY/$ipsenv"
PUTKEY="$restput $KEYSTORE/$SESSIONKEY"
PUTENV="$PUTKEY/$ipsenv"
LISTKEYS="$($KEYCURL $KEYSTORE/$SESSIONKEY/?${restsort})"
KEYSTATS=$($KEYCURL $KEYHOST/v2/stats/store)
# 
#

# add some general functions for our scripts


#tail -F /path/to/serverLog | while read ; do msgbus ; done &>>/dev/null &!
msgbus() {
    STREAMIT="$restput $KEYSTORE/stream"
	messagein="$@"
	tstamp=$(date +"%a %r")
	stamp=$(head -c 32 /dev/urandom | tr -dc 'a-zA-Z0-9' | head -c 32)
	ksig="[ $stamp ]"
	tsecs=$(date +"%s")
	mhost=$(hostname)
	messageout="$mhost : $tstamp $messagein $ksig"
	msglog="$tstamp $messagein $ksig"
#	eval "${PUTKEY}/msg/${BUD}/${mhost}/${tsecs}/?ttl=\"${msgttl}\" -d value=\"${msglog}\"" 1>/dev/null
	eval "${STREAMIT} -d value=\"${messageout}\"" 1>/dev/null
}


